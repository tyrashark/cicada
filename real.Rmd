---
title: "Cicada project simulation"
author: "Sungmin Ji"
date: '2022-12-21'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
rm(list = ls())
source("functions.R")
#library(ggplot2)
library(tidyverse)
#library(mclust)

m_mongol = read.csv("M_mongolica_data.csv", header=T)

m_mongol$Head.width = m_mongol$Head.width + runif(391, min = -.005, max = 0.005)

m_mongol = m_mongol %>% arrange(Head.width)
m_mongol = as_tibble(m_mongol) %>% mutate(Instar = as.character(Instar)) %>% mutate(log_trans = log(Head.width))

```


```{r}
## Descrptive analysis


install.packages("summarytools")
library(summarytools)


descr(m_mongol$Head.width,
      headings = FALSE, # remove headings
      stats = "common" # most common descriptive statistics
)


stby(data = m_mongol,
      INDICES = m_mongol$Instar,
      FUN = descr,
      stats = "common" # most common descriptive statistics
)


install.packages("psych")
library(psych)
describeBy(
  m_mongol,
  m_mongol$Instar # grouping variable
)

```


```{r fig.height=4, fig.width=10}
K_min = 3
K_max = 8
x = m_mongol$log_trans
BIC = matrix(0, nrow = K_max-3+1, ncol = 4)

rownames(BIC) = K_min:K_max
colnames(BIC) = paste0("h", 1:4)

ICL = BIC
LR = BIC
result = list()
#delete = c(209, 210)
delete = 999
for(k in K_min:K_max){
  result[[k-2]] = ECM(x, K=k, ini_method = "kmeans", delete = delete, tol = 1e-8)
}


for(k in K_min:K_max){
  BIC[k-2, ] = result[[k-2]]$criteria[,1]
  ICL[k-2, ] = result[[k-2]]$criteria[,2]
  LR[k-2, ] = result[[k-2]]$criteria[,3]
  par(mfrow = c(2,2))
  plot(-(result[[k-2]]$log_likelihood$h1 %>% na.omit()), ylab = "negative log-likelihood", main = "h1")
   plot(-(result[[k-2]]$log_likelihood$h2 %>% na.omit()),  ylab = "negative log-likelihood", main = "h2")
    plot(-(result[[k-2]]$log_likelihood$h3 %>% na.omit()),  ylab = "negative log-likelihood", main = "h3")
     plot(-(result[[k-2]]$log_likelihood$h4 %>% na.omit()),  ylab = "negative log-likelihood", main = "h4")
}

leg_label = c()
for(i in 1:4){
  leg_label = c(leg_label, bquote(italic(M)[.(paste0(i,"G"))]))
}
leg_label

par(mfrow = c(1,2))
matplot(K_min:K_max, BIC, type = "b", col=c(2,2,4,4), lty=c(1,2,1,2), xlab = "Number of instars", main = "", lwd = 2, cex.lab=1.3)
legend("topright", legend =  leg_label, col=c(2,2,4,4), lty=c(1,2,1,2), lwd = 2)
matplot(K_min:K_max, ICL, type = "b", col=c(2,2,4,4), lty=c(1,2,1,2), xlab = "Number of instars", main = "", lwd = 2, cex.lab=1.3)
legend("topright", legend = leg_label, col=c(2,2,4,4),  lty=c(1,2,1,2), lwd = 2)


apply(BIC, 2, which.min)+2
apply(ICL, 2, which.min)+2

estimate = result[[5-2]]$est

par(mfrow = c(1,1))
hist(x, breaks = 100, prob=T, main = "", xlab = "ln head capsule width", cex.lab=1.3)
legend("topleft", legend = leg_label, col=c(2,2,4,4), lty=c(1,2,1,2), lwd = 2, cex = 1.3)
for(i in 1:4){
  curve(Mixden(x, p = estimate$p[,i],mu = estimate$mu[,i], sigma = sqrt(estimate$sigma_sq[,i])), from = min(x)-0.3, to = max(x)+0.3, add = T, col=((i %/%3+1)*2), lty = (i %% 2+1), lwd = 2)
}

table(m_mongol$Instar[-delete] %>% as.numeric(), result[[5-2]]$classified$h1)
table(m_mongol$Instar[-delete] %>% as.numeric(), result[[5-2]]$classified$h2)
table(m_mongol$Instar[-delete] %>% as.numeric(), result[[5-2]]$classified$h3)
table(m_mongol$Instar[-delete] %>% as.numeric(), result[[5-2]]$classified$h4)


ICL
BIC
round(-2*(LR[3,] - 91.55739),1)
```


```{r}
x = m_mongol$log_trans

set.seed(300)
real_comp = find_comp(x, ini_method = "kmeans", tol = 1e-8)
real_boot = sapply(para_boot_LR(x, K=5, bootnum = 999, max_it = 1e3, tol = 1e-8, max_it.boot = 5e2, tol.boot = 1e-6, conv.deal = T), FUN = function(x) x)

real_boot
hypo_test(real_boot, alpha = 0.05, adj.method = "bonferroni")
```




